---
title: "Functions for measures and tests"
author: "Laura Grajeda"
date: "`r Sys.Date()`"
output: html_document
---
 


# 1. Function to compute measures


This functions transforms the data from timecourse and produce measure level summaries. The function includes the computation of FRes and AX.

```{r}
ComputeMeasures <- function(TimecourseDT){
  
  # CALCULATE R's AND X's
  #----------------------
  # Calculate ta summary statistic of the timecourse impedance data to obtain measurement level data
  MeasuresDT <- TimecourseDT %>% 
    group_by(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit) %>% 
    summarise(
              # using the mean
              M.R7_mean = mean(R7, na.rm=T),
              M.R11_mean = mean(R11, na.rm=T),
              M.R13_mean = mean(R13, na.rm=T),
              M.R17_mean = mean(R17, na.rm=T),
              M.R19_mean = mean(R19, na.rm=T),
              M.R23_mean = mean(R23, na.rm=T),
              M.R29_mean = mean(R29, na.rm=T),
              M.R31_mean = mean(R31, na.rm=T),
              M.R37_mean = mean(R37, na.rm=T),
              M.R41_mean = mean(R41, na.rm=T),
              
              M.X7_mean = mean(X7, na.rm=T),
              M.X11_mean = mean(X11, na.rm=T),
              M.X13_mean = mean(X13, na.rm=T),
              M.X17_mean = mean(X17, na.rm=T),
              M.X19_mean = mean(X19, na.rm=T),
              M.X23_mean = mean(X23, na.rm=T),
              M.X29_mean = mean(X29, na.rm=T),
              M.X31_mean = mean(X31, na.rm=T),
              M.X37_mean = mean(X37, na.rm=T),
              M.X41_mean = mean(X41, na.rm=T),
              
              # using the median
              M.R7_median = median(R7, na.rm=T),
              M.R19_median = median(R19, na.rm=T),
              M.X7_median = median(X7, na.rm=T),
              M.X11_median = median(X11, na.rm=T),
              M.X13_median = median(X13, na.rm=T),
              M.X17_median = median(X17, na.rm=T),
              M.X19_median = median(X19, na.rm=T),
              M.X23_median = median(X23, na.rm=T),
              M.X29_median = median(X29, na.rm=T),
              M.X31_median = median(X31, na.rm=T),
              M.X37_median = median(X37, na.rm=T),
              M.X41_median = median(X41, na.rm=T),
              
              # using the sd
              M.R7_sd = sd(R7, na.rm=T),
              M.X7_sd = sd(X7, na.rm=T),
              
              # using the IQR
              M.R7_IQR = quantile(R7, 0.75, na.rm=T) - quantile(R7, 0.25, na.rm=T),
              M.X7_IQR = quantile(X7, 0.75, na.rm=T) - quantile(X7, 0.25, na.rm=T)) %>% 
  ungroup() 
  
  # CALCULATE R7-R19
  #-------------------
  MeasuresDT <- MeasuresDT %>% 
  mutate(M.R7R19_mean = M.R7_mean-M.R19_mean,
         M.R7R19_median = M.R7_median-M.R19_median)
  
  
  # CALCULATE FRES
  #-------------------
  # FRes is defined here as the frequency when the reactance becomes 0. 
  # It is calculated from the line that forms between the two frequencies where the smaller frequency has a negative sign and the higher frequency has a positive sign.
  MeasuresDT <- MeasuresDT %>% 
    rowwise() %>% 
    mutate(
      # FRES 41- 37
      slope4137 = case_when(
         M.X41_mean>0 & M.X37_mean <0 ~ (M.X41_mean-M.X37_mean)/(41-37),
         TRUE ~ NA_real_),
      int4137 = M.X41_mean-(slope4137*41),
      fres4137 = abs(int4137/slope4137),
      
      # FRES 37- 31
      slope3731 = case_when(
         M.X37_mean>0 & M.X31_mean <0 ~ (M.X37_mean-M.X31_mean)/(37-31),
         TRUE ~ NA_real_),
      int3731 = M.X37_mean-(slope3731*37),
      fres3731 = abs(int3731/slope3731),
      
      # FRES 31- 29
      slope3129 = case_when(
         M.X31_mean>0 & M.X29_mean <0 ~ (M.X31_mean-M.X29_mean)/(31-29),
         TRUE ~ NA_real_),
      int3129 = M.X31_mean-(slope3129*31),
      fres3129 = abs(int3129/slope3129),
      
      # FRES 29- 23
      slope2923 = case_when(
         M.X29_mean>0 & M.X23_mean <0 ~ (M.X29_mean-M.X23_mean)/(29-23),
         TRUE ~ NA_real_),
      int2923 = M.X29_mean-(slope2923*29),
      fres2923 = abs(int2923/slope2923),
      
      # FRES 23- 19
      slope2319 = case_when(
         M.X23_mean>0 & M.X19_mean <0 ~ (M.X23_mean-M.X19_mean)/(23-19),
         TRUE ~ NA_real_),
      int2319 = M.X23_mean-(slope2319*23),
      fres2319 = abs(int2319/slope2319),
      
      # FRES 19- 17
      slope1917 = case_when(
         M.X19_mean>0 & M.X17_mean <0 ~ (M.X19_mean-M.X17_mean)/(19-17),
         TRUE ~ NA_real_),
      int1917 = M.X19_mean-(slope1917*19),
      fres1917 = abs(int1917/slope1917),
      
      # FRES 17- 13
      slope1713 = case_when(
         M.X17_mean>0 & M.X13_mean <0 ~ (M.X17_mean-M.X13_mean)/(17-13),
         TRUE ~ NA_real_),
      int1713 = M.X17_mean-(slope1713*17),
      fres1713 = abs(int1713/slope1713),
      
      # FRES 13- 11
      slope1311 = case_when(
         M.X13_mean>0 & M.X11_mean <0 ~ (M.X13_mean-M.X11_mean)/(13-11),
         TRUE ~ NA_real_),
      int1311 = M.X13_mean-(slope1311*13),
      fres1311 = abs(int1311/slope1311),
      
      # FRES 11- 7
      slope117 = case_when(
         M.X11_mean>0 & M.X7_mean <0 ~ (M.X11_mean-M.X7_mean)/(11-7),
         TRUE ~ NA_real_),
      int117 = M.X11_mean-(slope117*11),
      fres117 = abs(int117/slope117),
     
      # FRES
      FRes = case_when(
        !is.na(fres4137) ~ fres4137,
        !is.na(fres3731) ~ fres3731,
        !is.na(fres3129) ~ fres3129,
        !is.na(fres2923) ~ fres2923,
        !is.na(fres2319) ~ fres2319,
        !is.na(fres1917) ~ fres1917,
        !is.na(fres1713) ~ fres1713,
        !is.na(fres1311) ~ fres1311,
        !is.na(fres117) ~ fres117,
        TRUE ~ NA_real_)) %>% 
    select(-contains("slope"),  
           -int4137, -int3731, -int3129, -int2923, -int2319, -int1917, -int1713, -int1311, -int117,
           -fres4137, -fres3731, -fres3129, -fres2923, -fres2319, -fres1917, -fres1713, -fres1311, -fres117)
  
  
  # CALCULATE AX
  #---------------
  # For each measure creates a variable named "freq" with the value of FRes. It also creates a variable named "val" that is 0 when FRES exist and NA when FRES doesnt exist. It assigns 0 because the reactance at FRES by definition is 0.
  FRES <- MeasuresDT %>% 
  select(hhid, Day, TestWithinDay, MeasureWithinTest, Visit, FRes) %>% 
  rename("Freq"=FRes) %>% 
  mutate(val = ifelse(!is.na(Freq),0, NA))
  
  # Creates a list of tables, one per measurement. Each table is in long format with a row for each frequency (prime numbers between 7 and 41). Therefore, each table has 10 rows. However, if FRES exist, the table ends at the FRES frequency. Therefore it usually has less than 10 rows.
  LongList <-MeasuresDT %>% 
  select(hhid, Day, TestWithinDay, MeasureWithinTest, Visit,
         "M.X07_mean"=M.X7_mean, M.X11_mean, M.X13_mean, M.X17_mean, M.X19_mean, 
         M.X23_mean, M.X29_mean, M.X31_mean, M.X37_mean, M.X41_mean) %>%
  pivot_longer(cols=M.X07_mean:M.X41_mean,
             names_to = "Freq",
             names_prefix = "M.X",
             values_to = "val") %>% 
  mutate(Freq = as.numeric(substr(Freq,1,2)),
         val = val*-1) %>% 
  bind_rows(FRES) %>% 
  filter(val>=0)  %>% 
  arrange(hhid, Day, TestWithinDay, MeasureWithinTest, Visit) %>% 
  group_split(hhid, Day, TestWithinDay, MeasureWithinTest, Visit) 
  
  
  # Aproxfun() takes a combination of data points (x and y values) as input and returns a stepwise linear interpolation function. Then, integrate() integrates the area above the linear interpolation, aka the reactance curve. Here, I am only creating the function, later I will apply it to each measurement in the list with sapply(). https://advanced-r-solutions.rbind.io/function-factories
  CalAx <- function(Long){
  AX = integrate(approxfun(Long$Freq, Long$val),lower=min(Long$Freq), upper=max(Long$Freq))$value
  AX
  }
  
  ExtractID <- function(Long){
  hhid = Long$hhid[1]
  Day = Long$Day[1]
  TestWithinDay = Long$TestWithinDay[1]
  MeasureWithinTest = Long$MeasureWithinTest[1]
  Visit = Long$Visit[1]
  ID = paste0(hhid, "-", Day, "-", TestWithinDay, "-", MeasureWithinTest, "-", Visit)
  ID
  }
  
  AXvector <- data.frame(AX=sapply(LongList, CalAx),
                         ID = sapply(LongList, ExtractID))
  
  MeasuresDT <- MeasuresDT %>% 
    mutate(ID = paste0(hhid, "-", Day, "-", TestWithinDay, "-", MeasureWithinTest, "-", Visit)) %>% 
    merge(AXvector, by="ID") %>% 
    select(-ID)
  
  MeasuresDT
}
```






# 2.  Function to select measures - the closest 4


## Closest 4

```{r}
SelectClosest4 <- function(MeasuresDT, 
                           R7est, R11est, R13est, R17est, R19est, R23est, R29est, R31est, R37est, R41est, 
                           X7est, R7R19est, AXest, FResest){
  
  `%notin%` <- Negate(`%in%`)
  
  MeasuresDT <- MeasuresDT %>% 
    mutate(ID = paste0(hhid,"_", Day, "_", TestWithinDay, "_", Visit))
  
  MeasuresDT$R7 <- R7est
  MeasuresDT$R11 <- R11est
  MeasuresDT$R13 <- R13est
  MeasuresDT$R17 <- R17est
  MeasuresDT$R19 <- R19est
  MeasuresDT$R23 <- R23est
  MeasuresDT$R29 <- R29est
  MeasuresDT$R31 <- R31est
  MeasuresDT$R37 <- R37est
  MeasuresDT$R41 <- R41est
  
  MeasuresDT$X7 <- X7est
  MeasuresDT$R7R19 <- R7R19est
  MeasuresDT$AX <- AXest
  MeasuresDT$FRes <- FResest
  
  # This are test with 4 or less measures. Because of the small number of measures, I wont be able to pick.
  IdsWithLessThan4Measures <- MeasuresDT %>% 
    count(ID) %>% 
    filter(n<=4) %>% 
    select(ID) %>% t() %>% as.character()
  
  IdsWithLessThan4MeasuresFRes <- MeasuresDT %>% 
    filter(!is.na(FRes)) %>% 
    count(ID) %>% 
    filter(n<=4) %>% 
    select(ID) %>% t() %>% as.character()
  
  # For R7
  ############
  # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R7, .by_group=TRUE) %>% 
     mutate(delta = R7 - lag(R7,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add the selected 4 measures, and the measure where I wasn't able to pick
  R7Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R7)
  
  # For X7
  ############
  # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(X7, .by_group=TRUE) %>% 
     mutate(delta = X7 - lag(X7,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  X7Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, X7)
  
  # For R7R19
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R7R19, .by_group=TRUE) %>% 
     mutate(delta = R7R19 - lag(R7R19,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R7R19Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R7R19)
  
  
  # For R11
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R11, .by_group=TRUE) %>% 
     mutate(delta = R11 - lag(R11,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R11Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R11)
  
  
  # For R13
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R13, .by_group=TRUE) %>% 
     mutate(delta = R13 - lag(R13,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R13Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R13)
  
  
  # For R17
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R17, .by_group=TRUE) %>% 
     mutate(delta = R17 - lag(R17,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R17Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R17)
  
  
  # For R19
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R19, .by_group=TRUE) %>% 
     mutate(delta = R19 - lag(R19,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R19Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R19)
  
  
  # For R23
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R23, .by_group=TRUE) %>% 
     mutate(delta = R23 - lag(R23,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R23Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R23)
  
  
  # For R29
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R29, .by_group=TRUE) %>% 
     mutate(delta = R29 - lag(R29,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R29Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R29)
  
  
  # For R31
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R31, .by_group=TRUE) %>% 
     mutate(delta = R31 - lag(R31,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R31Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R31)
  
  # For R37
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R37, .by_group=TRUE) %>% 
     mutate(delta = R37 - lag(R37,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R37Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R37)
  
  # For R41
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R41, .by_group=TRUE) %>% 
     mutate(delta = R41 - lag(R41,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  R41Measures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R41)
  
  # For AX
  ############
    # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(AX, .by_group=TRUE) %>% 
     mutate(delta = AX - lag(AX,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add both
  AXMeasures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, AX)
  
  
  # For FRes
  ############
  # Select closest
  Close <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan4Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(FRes, .by_group=TRUE) %>% 
     mutate(delta = FRes - lag(FRes,3),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0),
           Cual4 = ifelse(lead(Cual3)==1,1,0))  %>% 
    mutate(Close4 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 | Cual4==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close4==1)

  # Add the selected 4 measures, and the measure where I wasn't able to pick
  FResMeasures<-MeasuresDT %>%
     filter(ID %in% c(IdsWithLessThan4Measures)) %>% 
     bind_rows(Close) %>% 
     select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, FRes)
  

  # MERGE
  ########
  SelMeasures <- R7Measures %>% 
    merge(X7Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R7R19Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    
    merge(R11Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R13Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R17Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R19Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R23Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R29Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R31Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R37Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R41Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    
    merge(AXMeasures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(FResMeasures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T)

  SelMeasures
}

```


## Closest 3 exactly 3

```{r}
SelectClosest3_exact <- function(MeasuresDT, 
                           R7est, R11est, R13est, R17est, R19est, R23est, R29est, R31est, R37est, R41est, 
                           X7est, R7R19est, AXest, FResest){
  
  `%notin%` <- Negate(`%in%`)
  
  MeasuresDT <- MeasuresDT %>% 
    mutate(ID = paste0(hhid,"_", Day, "_", TestWithinDay, "_", Visit))
  
  MeasuresDT$R7 <- R7est
  MeasuresDT$R11 <- R11est
  MeasuresDT$R13 <- R13est
  MeasuresDT$R17 <- R17est
  MeasuresDT$R19 <- R19est
  MeasuresDT$R23 <- R23est
  MeasuresDT$R29 <- R29est
  MeasuresDT$R31 <- R31est
  MeasuresDT$R37 <- R37est
  MeasuresDT$R41 <- R41est
  
  MeasuresDT$X7 <- X7est
  MeasuresDT$R7R19 <- R7R19est
  MeasuresDT$AX <- AXest
  MeasuresDT$FRes <- FResest
  
  # This are test with LESS THAN 4 MEASURES. Because of the small number of measures, I wont be able to pick.
  IdsWithLessThan3Measures <- MeasuresDT %>% 
    count(ID) %>% 
    filter(n<3) %>% 
    select(ID) %>% t() %>% as.character()
  
  IdsWithLessThan3MeasuresFRes <- MeasuresDT %>% 
    filter(!is.na(FRes)) %>% 
    count(ID) %>% 
    filter(n<3) %>% 
    select(ID) %>% t() %>% as.character()
  
  # For R7
  ############
  # Select closest
  R7Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R7, .by_group=TRUE) %>% 
     mutate(delta = R7 - lag(R7,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R7)

  
  # For X7
  ############
  # Select closest
  X7Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(X7, .by_group=TRUE) %>% 
     mutate(delta = X7 - lag(X7,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1  ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, X7)
  
  # For R7R19
  ############
    # Select closest
  R7R19Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R7R19, .by_group=TRUE) %>% 
     mutate(delta = R7R19 - lag(R7R19,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R7R19)
  
  
  # For R11
  ############
    # Select closest
  R11Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R11, .by_group=TRUE) %>% 
     mutate(delta = R11 - lag(R11,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R11)
  
  
  # For R13
  ############
    # Select closest
  R13Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R13, .by_group=TRUE) %>% 
     mutate(delta = R13 - lag(R13,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R13)
  
  
  # For R17
  ############
    # Select closest
  R17Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R17, .by_group=TRUE) %>% 
     mutate(delta = R17 - lag(R17,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R17)
  
  
  # For R19
  ############
    # Select closest
  R19Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R19, .by_group=TRUE) %>% 
     mutate(delta = R19 - lag(R19,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R19)
  
  
  # For R23
  ############
    # Select closest
  R23Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R23, .by_group=TRUE) %>% 
     mutate(delta = R23 - lag(R23,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R23)
  
  
  # For R29
  ############
    # Select closest
  R29Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R29, .by_group=TRUE) %>% 
     mutate(delta = R29 - lag(R29,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R29)
  
  
  # For R31
  ############
    # Select closest
  R31Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R31, .by_group=TRUE) %>% 
     mutate(delta = R31 - lag(R31,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R31)
  
  # For R37
  ############
    # Select closest
  R37Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R37, .by_group=TRUE) %>% 
     mutate(delta = R37 - lag(R37,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R37)
  
  # For R41
  ############
    # Select closest
  R41Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(R41, .by_group=TRUE) %>% 
     mutate(delta = R41 - lag(R41,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R41)
  
  # For AX
  ############
    # Select closest
  AXMeasures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(AX, .by_group=TRUE) %>% 
     mutate(delta = AX - lag(AX,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, AX)
  
  
  # For FRes
  ############
  # Select closest
  FResMeasures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(hhid, Day, TestWithinDay, Visit) %>% 
     arrange(FRes, .by_group=TRUE) %>% 
     mutate(delta = FRes - lag(FRes,2),
           min = min(delta, na.rm = T),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1  ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, FRes)
  

  # MERGE
  ########
  SelMeasures <- R7Measures %>% 
    merge(X7Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R7R19Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    
    merge(R11Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R13Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R17Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R19Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R23Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R29Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R31Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R37Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(R41Measures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    
    merge(AXMeasures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(FResMeasures, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T)

  SelMeasures
}

```





# 3. Functions to select measures - Distance of the measure to the mean of the test


## Distance 15

```{r}
SelectOnDisttoMean15 <- function(MeasuresDT, R7est, X7est, R7R19est, AXest, FResest){
  
  MeasuresDT$R7 <- R7est
  MeasuresDT$X7 <- X7est
  MeasuresDT$R7R19 <- R7R19est
  MeasuresDT$AX <- AXest
  MeasuresDT$FRes <- FResest
  
  # For R7
  #-----------
  Means <- MeasuresDT %>% 
    group_by(hhid, Day, TestWithinDay, Visit) %>% 
    reframe(mean = mean(R7, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("hhid", "Day", "TestWithinDay", "Visit")) %>%
  rowwise() %>% 
  mutate(Distance = R7-mean) %>% 
  ungroup() 

  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelR7 <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>% #| is.na(Drop) 
    select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R7)
  
  # Remove tests with only 1 measure
  IDs <- SelR7 %>% 
    count(hhid, Day, TestWithinDay) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% select(ID) %>% t() %>% as.character()

  SelR7 <- SelR7 %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  # For X7
  #-----------
  Means <- MeasuresDT %>% 
    group_by(hhid, Day, TestWithinDay, Visit) %>% 
    reframe(mean = mean(X7, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("hhid", "Day", "TestWithinDay", "Visit")) %>%
  rowwise() %>% 
  mutate(Distance = X7-mean) %>% 
  ungroup() 
   
  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelX7 <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>% #| is.na(Drop) 
    select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, X7)
  
  # Remove tests with only 1 measure
  IDs <- SelX7 %>% 
    count(hhid, Day, TestWithinDay) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% select(ID) %>% t() %>% as.character()

  SelX7 <- SelX7 %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  # For R7R19
  #-----------
  Means <- MeasuresDT %>% 
    group_by(hhid, Day, TestWithinDay, Visit) %>% 
    reframe(mean = mean(R7R19, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("hhid", "Day", "TestWithinDay", "Visit")) %>%
  rowwise() %>% 
  mutate(Distance = R7R19-mean) %>% 
  ungroup() 
   
  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelR7R19 <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>% #| is.na(Drop) 
    select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, R7R19)
  
  # Remove tests with only 1 measure
  IDs <- SelR7R19 %>% 
    count(hhid, Day, TestWithinDay) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% select(ID) %>% t() %>% as.character()

  SelR7R19 <- SelR7R19 %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  # For AX
  #-----------
  Means <- MeasuresDT %>% 
    group_by(hhid, Day, TestWithinDay, Visit) %>% 
    reframe(mean = mean(AX, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("hhid", "Day", "TestWithinDay", "Visit")) %>%
  rowwise() %>% 
  mutate(Distance = AX-mean) %>% 
  ungroup() 
   
  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelAX <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>% #| is.na(Drop)
    select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, AX)
  
  # Remove tests with only 1 measure
  IDs <- SelAX %>% 
    count(hhid, Day, TestWithinDay) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% select(ID) %>% t() %>% as.character()

  SelAX <- SelAX %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  # For FRES
  #-----------
  Means <- MeasuresDT %>% 
    group_by(hhid, Day, TestWithinDay, Visit) %>% 
    reframe(mean = mean(FRes, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("hhid", "Day", "TestWithinDay", "Visit")) %>%
  rowwise() %>% 
  mutate(Distance = FRes-mean) %>% 
  ungroup() 
   
  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelFRes <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>% # | is.na(Drop) 
    select(hhid, Day, TestWithinDay, MeasureWithinTest, Timestamp, Visit, FRes)
  
  # Remove tests with only 1 measure
  IDs <- SelFRes %>% 
    count(hhid, Day, TestWithinDay) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% select(ID) %>% t() %>% as.character()

  SelFRes <- SelFRes %>% 
    mutate(ID=paste0(hhid, "_", Day, "_", TestWithinDay)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  # MERGE
  #--------
  SelMeasures <- SelR7 %>% 
    merge(SelX7, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(SelR7R19, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(SelAX, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) %>% 
    merge(SelFRes, by=c("hhid", "Day", "TestWithinDay", "MeasureWithinTest", "Timestamp", "Visit"), all=T) 

  SelMeasures
  
  }
```





# 4. Function to select measures - R7 CoV

```{r}
ChooseXFromFirstY <- function(data, idsToRemove, choose, fromFirst){
  
  `%notin%` <- Negate(`%in%`)
  
  # Choose measurements that did not had a cv<15 before
  FOT2 <- data %>% 
    mutate(.,id = paste0(hhid, "-", Day, "-", TestWithinDay, "-", Visit)) %>%
    filter(id %notin% c(idsToRemove)) 

  # Choose combinations of measurements to try
  ChooseXfromFirstY <- data.frame(arrangements::combinations(seq(1,fromFirst, by=1), choose))
  ChooseXfromFirstY_minus1 <- data.frame(arrangements::combinations(seq(1, fromFirst-1, by=1), choose))
  ChooseXfromFirstYUni <- ChooseXfromFirstY %>% setdiff(ChooseXfromFirstY_minus1)
  
  # Calculate test averages from the combinations not tried before
  SEL <- data.frame()
     for (z in 1:nrow(ChooseXfromFirstYUni)) {
     SEL <- SEL %>%  
               bind_rows(bind_cols(CreateTest(c(as.vector(ChooseXfromFirstYUni[z,])), FOT2), ChooseXfromFirstYUni[z,]))
   }
   
  # Select the tests with X measurements, that have a cv <= 15 and has the smallest combined CV
  SEL <- SEL %>% 
    filter(total==choose & r7_cv<=15) %>%
    rowwise() %>%
    mutate(sum = r7_cv) %>%
    ungroup() 
  
  SEL <- SEL %>% 
    group_by(., hhid, "-", Day, "-", TestWithinDay, "-", Visit) %>% 
    mutate(Choose = ifelse(sum == min(sum),1,0)) %>%
    ungroup() %>%
    filter(Choose==1) 
  
 # Extraer las medidas que cumplen el criterio
  SEL <- SEL %>%
    pivot_longer(cols = X1:paste0("X",choose),
                   names_to = "Selection",
                   names_prefix = "X",
                   values_to = "MeasNumber") %>% 
    mutate(MeasureWithinTest = paste0("Measure ", MeasNumber)) %>% 
    select(hhid, Day, TestWithinDay, MeasureWithinTest, Visit) %>% 
    merge(data, all.x = T) 
    
  
# Extraer los ids de los tests que tienen un cv <15, estos ya cumplieron el criterio.
  ids <- SEL %>%
    mutate(.,id = paste0(hhid, "-", Day, "-", TestWithinDay, "-", Visit)) %>%
    select(id) %>%
    distinct() %>% 
    t() %>% as.character()
  
  # output
  list(SEL=SEL, ids=ids)
}
```



```{r}
CreateTest <- function(M, data){
    # Filter to selectt measures 
    data <- data %>%
        mutate(measNum=as.numeric(substring(MeasureWithinTest, 9,9))) %>% 
        filter(measNum %in% c(M)) 
    # Group by to select the level of the test
    data %>%
       group_by(., hhid, Day, TestWithinDay, Visit) %>% 
    # Summarize
    summarise(total = n(), 
            r7_mean = mean(M.R7_mean),
            r7_sd = sd(M.R7_mean),
            r7_cv = r7_sd / r7_mean*100) %>%
     ungroup() 
 }
```


# 5. Function to compute tests

```{r}
ComputeTests_some <- function(MeasuresDT){
  
  TestDT <- MeasuresDT %>% 
    mutate(Date = as.Date(Timestamp)) %>% 
    group_by(hhid, Day, TestWithinDay, Date, Visit) %>% 
    reframe(nMeasuresContributing = n(), 
            # Resistance
            R7_mean =mean(R7, na.rm=T),
            R7_sd = sd(R7, na.rm=T),
            R7_Cov = R7_sd/R7_mean*100,
            X7_mean = mean(X7, na.rm=T),
            X7_sd = sd(X7, na.rm=T),
            R7R19_mean = mean(R7R19, na.rm=T),
            R7R19_sd = sd(R7R19, na.rm=T),
            AX_mean = mean(AX, na.rm=T),
            AX_sd = sd(AX, na.rm=T),
            FRes_mean = mean(FRes, na.rm=T),
            Fres_sd = sd(FRes, na.rm=T)) 
  
  TestDT
  
}



ComputeTests <- function(MeasuresDT){
  
  TestDT <- MeasuresDT %>% 
    mutate(Date = as.Date(Timestamp)) %>% 
    group_by(hhid, Day, TestWithinDay, Date, Visit) %>% 
    reframe(nMeasuresContributing = n(), 
            # Resistance
            R7_mean =mean(R7, na.rm=T),
            R7_sd = sd(R7, na.rm=T),
            R7_Cov = R7_sd/R7_mean*100,
            R11_mean =mean(R11, na.rm=T),
            R11_sd = sd(R11, na.rm=T),
            R13_mean =mean(R13, na.rm=T),
            R13_sd = sd(R13, na.rm=T),
            R17_mean =mean(R17, na.rm=T),
            R17_sd = sd(R17, na.rm=T),
            R19_mean =mean(R19, na.rm=T),
            R19_sd = sd(R19, na.rm=T),
            R23_mean =mean(R23, na.rm=T),
            R23_sd = sd(R23, na.rm=T),
            R29_mean =mean(R29, na.rm=T),
            R29_sd = sd(R29, na.rm=T),
            R31_mean =mean(R31, na.rm=T),
            R31_sd = sd(R31, na.rm=T),
            R37_mean =mean(R37, na.rm=T),
            R37_sd = sd(R37, na.rm=T),
            R41_mean =mean(R41, na.rm=T),
            R41_sd = sd(R41, na.rm=T),
            
            X7_mean = mean(X7, na.rm=T),
            X7_sd = sd(X7, na.rm=T),
            # X11_mean =mean(X11, na.rm=T),
            # X11_sd = sd(X11, na.rm=T),
            # X13_mean =mean(X13, na.rm=T),
            # X13_sd = sd(X13, na.rm=T),
            # X17_mean =mean(X17, na.rm=T),
            # X17_sd = sd(X17, na.rm=T),
            # X19_mean =mean(X19, na.rm=T),
            # X19_sd = sd(X19, na.rm=T),
            # X23_mean =mean(X23, na.rm=T),
            # X23_sd = sd(X23, na.rm=T),
            # X29_mean =mean(X29, na.rm=T),
            # X29_sd = sd(X29, na.rm=T),
            # X31_mean =mean(X31, na.rm=T),
            # X31_sd = sd(X31, na.rm=T),
            # X37_mean =mean(X37, na.rm=T),
            # X37_sd = sd(X37, na.rm=T),
            # X41_mean =mean(X41, na.rm=T),
            # X41_sd = sd(X41, na.rm=T),
            
            R7R19_mean = mean(R7R19, na.rm=T),
            R7R19_sd = sd(R7R19, na.rm=T),
            AX_mean = mean(AX, na.rm=T),
            AX_sd = sd(AX, na.rm=T),
            FRes_mean = mean(FRes, na.rm=T),
            Fres_sd = sd(FRes, na.rm=T)) 
  
  TestDT
  
}
```


