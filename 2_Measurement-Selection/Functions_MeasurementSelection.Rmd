---
title: "Functions for measures and tests"
author: "Laura Grajeda"
date: "`r Sys.Date()`"
output: html_document
---
 


# 1. Function to compute measures from timecourse


This functions use the data from timecourse to produce measure level summaries. The function includes the computation of FRes and AX.

```{r}
ComputeMeasures <- function(TimecourseDT){
  
  # CALCULATE R's AND X's
  #----------------------
  # Calculate ta summary statistic of the timecourse impedance data to obtain measurement level data
  MeasuresDT <- TimecourseDT %>% 
    group_by(patient,  timestamp, MeasureWithinTest) %>% 
    summarise(
              # using the mean
              M.R7 = mean(R7, na.rm=T),
              M.R11 = mean(R11, na.rm=T),
              M.R13 = mean(R13, na.rm=T),
              M.R17 = mean(R17, na.rm=T),
              M.R19 = mean(R19, na.rm=T),
              M.R23 = mean(R23, na.rm=T),
              M.R29 = mean(R29, na.rm=T),
              M.R31 = mean(R31, na.rm=T),
              M.R37 = mean(R37, na.rm=T),
              M.R41 = mean(R41, na.rm=T),
              
              M.X7 = mean(X7, na.rm=T),
              M.X11 = mean(X11, na.rm=T),
              M.X13 = mean(X13, na.rm=T),
              M.X17 = mean(X17, na.rm=T),
              M.X19 = mean(X19, na.rm=T),
              M.X23 = mean(X23, na.rm=T),
              M.X29 = mean(X29, na.rm=T),
              M.X31 = mean(X31, na.rm=T),
              M.X37 = mean(X37, na.rm=T),
              M.X41 = mean(X41, na.rm=T)) %>% 
  ungroup() 
  
  # CALCULATE R7-R19
  #-------------------
  MeasuresDT <- MeasuresDT %>% 
  mutate(M.R7R19 = M.R7-M.R19)
  
  
  # CALCULATE FRES
  #-------------------
  # FRes is defined here as the frequency when the reactance becomes 0. 
  # It is calculated from the line that forms between the two frequencies where the smaller frequency has a negative sign and the higher frequency has a positive sign.
  MeasuresDT <- MeasuresDT %>% 
    rowwise() %>% 
    mutate(
      # FRES 41- 37
      slope4137 = case_when(
         M.X41>0 & M.X37 <0 ~ (M.X41-M.X37)/(41-37),
         TRUE ~ NA_real_),
      int4137 = M.X41-(slope4137*41),
      fres4137 = abs(int4137/slope4137),
      
      # FRES 37- 31
      slope3731 = case_when(
         M.X37>0 & M.X31 <0 ~ (M.X37-M.X31)/(37-31),
         TRUE ~ NA_real_),
      int3731 = M.X37-(slope3731*37),
      fres3731 = abs(int3731/slope3731),
      
      # FRES 31- 29
      slope3129 = case_when(
         M.X31>0 & M.X29 <0 ~ (M.X31-M.X29)/(31-29),
         TRUE ~ NA_real_),
      int3129 = M.X31-(slope3129*31),
      fres3129 = abs(int3129/slope3129),
      
      # FRES 29- 23
      slope2923 = case_when(
         M.X29>0 & M.X23 <0 ~ (M.X29-M.X23)/(29-23),
         TRUE ~ NA_real_),
      int2923 = M.X29-(slope2923*29),
      fres2923 = abs(int2923/slope2923),
      
      # FRES 23- 19
      slope2319 = case_when(
         M.X23>0 & M.X19 <0 ~ (M.X23-M.X19)/(23-19),
         TRUE ~ NA_real_),
      int2319 = M.X23-(slope2319*23),
      fres2319 = abs(int2319/slope2319),
      
      # FRES 19- 17
      slope1917 = case_when(
         M.X19>0 & M.X17 <0 ~ (M.X19-M.X17)/(19-17),
         TRUE ~ NA_real_),
      int1917 = M.X19-(slope1917*19),
      fres1917 = abs(int1917/slope1917),
      
      # FRES 17- 13
      slope1713 = case_when(
         M.X17>0 & M.X13 <0 ~ (M.X17-M.X13)/(17-13),
         TRUE ~ NA_real_),
      int1713 = M.X17-(slope1713*17),
      fres1713 = abs(int1713/slope1713),
      
      # FRES 13- 11
      slope1311 = case_when(
         M.X13>0 & M.X11 <0 ~ (M.X13-M.X11)/(13-11),
         TRUE ~ NA_real_),
      int1311 = M.X13-(slope1311*13),
      fres1311 = abs(int1311/slope1311),
      
      # FRES 11- 7
      slope117 = case_when(
         M.X11>0 & M.X7 <0 ~ (M.X11-M.X7)/(11-7),
         TRUE ~ NA_real_),
      int117 = M.X11-(slope117*11),
      fres117 = abs(int117/slope117),
     
      # FRES
      M.FRes = case_when(
        !is.na(fres4137) ~ fres4137,
        !is.na(fres3731) ~ fres3731,
        !is.na(fres3129) ~ fres3129,
        !is.na(fres2923) ~ fres2923,
        !is.na(fres2319) ~ fres2319,
        !is.na(fres1917) ~ fres1917,
        !is.na(fres1713) ~ fres1713,
        !is.na(fres1311) ~ fres1311,
        !is.na(fres117) ~ fres117,
        TRUE ~ NA_real_)) %>% 
    select(-contains("slope"),  
           -int4137, -int3731, -int3129, -int2923, -int2319, -int1917, -int1713, -int1311, -int117,
           -fres4137, -fres3731, -fres3129, -fres2923, -fres2319, -fres1917, -fres1713, -fres1311, -fres117)
  
  
  # CALCULATE AX
  #---------------
  # For each measure creates a variable named "freq" with the value of FRes. It also creates a variable named "val" that is 0 when FRES exist and NA when FRES doesnt exist. It assigns 0 because the reactance at FRES by definition is 0.
  FRES <- MeasuresDT %>% 
  select(patient,  MeasureWithinTest, M.FRes) %>% 
  rename("Freq"=M.FRes) %>% 
  mutate(val = ifelse(!is.na(Freq),0, NA))
  
  # Creates a list of tables, one per measurement. Each table is in long format with a row for each frequency (prime numbers between 7 and 41). Therefore, each table has 10 rows. However, if FRES exist, the table ends at the FRES frequency. Therefore it usually has less than 10 rows.
  LongList <-MeasuresDT %>% 
  select(patient, MeasureWithinTest,
         "M.X07"=M.X7, M.X11, M.X13, M.X17, M.X19, 
         M.X23, M.X29, M.X31, M.X37, M.X41) %>%
  pivot_longer(cols=M.X07:M.X41,
             names_to = "Freq",
             names_prefix = "M.X",
             values_to = "val") %>% 
  mutate(Freq = as.numeric(substr(Freq,1,2)),
         val = val*-1) %>% 
  bind_rows(FRES) %>% 
  filter(val>=0)  %>% 
  arrange(patient, MeasureWithinTest) %>% 
  group_split(patient, MeasureWithinTest) 
  
  
  # Aproxfun() takes a combination of data points (x and y values) as input and returns a stepwise linear interpolation function. Then, integrate() integrates the area above the linear interpolation, aka the reactance curve. Here, I am only creating the function, later I will apply it to each measurement in the list with sapply(). https://advanced-r-solutions.rbind.io/function-factories
  CalAx <- function(Long){
  AX = integrate(approxfun(Long$Freq, Long$val),lower=min(Long$Freq), upper=max(Long$Freq))$value
  AX
  }
  
  ExtractID <- function(Long){
  patient = Long$patient[1]
  MeasureWithinTest = Long$MeasureWithinTest[1]
  ID = paste0(patient, "-", MeasureWithinTest)
  ID
  }
  
  AXvector <- data.frame(M.AX=sapply(LongList, CalAx),
                         ID = sapply(LongList, ExtractID))
  
  MeasuresDT <- MeasuresDT %>% 
    mutate(ID = paste0(patient, "-", MeasureWithinTest)) %>% 
    merge(AXvector, by="ID") %>% 
    select(-ID)
  
  MeasuresDT
}
```






# 2.  Functions to select measures 


## + Closest 3 

This function selects the 3 closest measurements among the artifact-free measurements.

```{r}
SelectClosest3_exact <- function(MeasuresDT, R7est, R11est, R13est, R17est, R19est, R23est, R29est, R31est, R37est, R41est, 
                           X7est, R7R19est, AXest, FResest){
  
  `%notin%` <- Negate(`%in%`)
  
  MeasuresDT <- MeasuresDT %>% 
    mutate(ID = paste0(patient))
  
  MeasuresDT$R7 <- R7est
  MeasuresDT$R11 <- R11est
  MeasuresDT$R13 <- R13est
  MeasuresDT$R17 <- R17est
  MeasuresDT$R19 <- R19est
  MeasuresDT$R23 <- R23est
  MeasuresDT$R29 <- R29est
  MeasuresDT$R31 <- R31est
  MeasuresDT$R37 <- R37est
  MeasuresDT$R41 <- R41est
  
  MeasuresDT$X7 <- X7est
  MeasuresDT$R7R19 <- R7R19est
  MeasuresDT$AX <- AXest
  MeasuresDT$FRes <- FResest
  
  # This are test with LESS THAN 4 MEASURES. Because of the small number of measures, I wont be able to pick.
  IdsWithLessThan3Measures <- MeasuresDT %>% 
    count(ID) %>% 
    filter(n<3) %>% 
    select(ID) %>% t() %>% as.character()
  
  IdsWithLessThan3MeasuresFRes <- MeasuresDT %>% 
    filter(!is.na(M.FRes)) %>% 
    count(ID) %>% 
    filter(n<3) %>% 
    select(ID) %>% t() %>% as.character()
  
  # For R7
  ############
  # Select closest
  R7Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R7, .by_group=TRUE) %>% 
     mutate(delta = R7 - lag(R7,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.R7"=R7)

  
  # For X7
  ############
  # Select closest
  X7Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(X7, .by_group=TRUE) %>% 
     mutate(delta = X7 - lag(X7,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1  ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.X7"=X7)
  
  # For R7R19
  ############
    # Select closest
  R7R19Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R7R19, .by_group=TRUE) %>% 
     mutate(delta = R7R19 - lag(R7R19,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.R7R19"=R7R19)
  
  
  # For R11
  ############
    # Select closest
  R11Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R11, .by_group=TRUE) %>% 
     mutate(delta = R11 - lag(R11,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.R11"=R11)
  
  
  # For R13
  ############
    # Select closest
  R13Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R13, .by_group=TRUE) %>% 
     mutate(delta = R13 - lag(R13,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.R13"=R13)
  
  
  # For R17
  ############
    # Select closest
  R17Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R17, .by_group=TRUE) %>% 
     mutate(delta = R17 - lag(R17,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.R17"=R17)
  
  
  # For R19
  ############
    # Select closest
  R19Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R19, .by_group=TRUE) %>% 
     mutate(delta = R19 - lag(R19,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.R19"=R19)
  
  
  # For R23
  ############
    # Select closest
  R23Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R23, .by_group=TRUE) %>% 
     mutate(delta = R23 - lag(R23,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest,timestamp, "M.R23"=R23)
  
  
  # For R29
  ############
    # Select closest
  R29Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R29, .by_group=TRUE) %>% 
     mutate(delta = R29 - lag(R29,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.R29"=R29)
  
  
  # For R31
  ############
    # Select closest
  R31Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R31, .by_group=TRUE) %>% 
     mutate(delta = R31 - lag(R31,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient, MeasureWithinTest, timestamp, "M.R31"=R31)
  
  # For R37
  ############
    # Select closest
  R37Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R37, .by_group=TRUE) %>% 
     mutate(delta = R37 - lag(R37,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.R37"=R37)
  
  # For R41
  ############
    # Select closest
  R41Measures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(R41, .by_group=TRUE) %>% 
     mutate(delta = R41 - lag(R41,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient, MeasureWithinTest, timestamp, "M.R41"=R41)
  
  # For AX
  ############
    # Select closest
  AXMeasures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(AX, .by_group=TRUE) %>% 
     mutate(delta = AX - lag(AX,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1 ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.AX"=AX)
  
  
  # For FRes
  ############
  # Select closest
  FResMeasures <- MeasuresDT %>% 
     filter(ID %notin% c(IdsWithLessThan3Measures)) %>% 
     group_by(patient) %>% 
     arrange(FRes, .by_group=TRUE) %>% 
     mutate(delta = FRes - lag(FRes,2),
           min = suppressWarnings(min(delta, na.rm = T)),
           Cual = ifelse(delta==min,1,0),
           Cual2 = ifelse(lead(Cual)==1,1,0),
           Cual3 = ifelse(lead(Cual2)==1,1,0))  %>% 
    mutate(Close3 = case_when(
      Cual==1 | Cual2==1 | Cual3==1  ~1,
      TRUE ~ 0)) %>% 
   ungroup() %>% 
   filter(Close3==1) %>% 
   select(patient,  MeasureWithinTest, timestamp, "M.FRes"=FRes)
  

  # MERGE
  ########
  SelMeasures <- R7Measures %>% 
    merge(X7Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R7R19Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    
    merge(R11Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R13Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R17Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R19Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R23Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R29Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R31Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R37Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(R41Measures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    
    merge(AXMeasures, by=c("patient","MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(FResMeasures, by=c("patient","MeasureWithinTest", "timestamp"), all=T)

  SelMeasures
}

```





## + Distance 15

Distance of the measure to the mean of the test.

```{r}
SelectOnDisttoMean15 <- function(MeasuresDT, R7est, X7est, R7R19est, AXest, FResest){
  
  MeasuresDT$R7 <- R7est
  MeasuresDT$X7 <- X7est
  MeasuresDT$R7R19 <- R7R19est
  MeasuresDT$AX <- AXest
  MeasuresDT$FRes <- FResest
  
  # For R7
  #-----------
  # Calculate test summaries
  Means <- MeasuresDT %>% 
    # group by test. In this example each patient has only 1 test.
    group_by(patient) %>% 
    reframe(mean = mean(R7, na.rm=T)) 
  
  # calculate the distance between the measure value and the test summary value
  New <- MeasuresDT %>%
    # merge by test. In this example each patient has only 1 test.
  merge(Means, by=c("patient")) %>%
  rowwise() %>% 
  mutate(Distance = R7-mean) %>% 
  ungroup() 

  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelR7 <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>%  
    select(patient, MeasureWithinTest, timestamp, "M.R7"=R7)
  
  # Remove tests with only 1 measure
  IDs <- SelR7 %>% 
    count(patient) %>% 
    filter(n==1) %>% 
    # ID for tests. In this example each patient has only 1 test.
    mutate(ID=paste0(patient)) %>% 
    select(ID) %>% t() %>% as.character()

  SelR7 <- SelR7 %>% 
    # ID for tests. In this example each patient has only 1 test.
    mutate(ID=paste0(patient)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  
  # For X7
  #-----------
  Means <- MeasuresDT %>% 
    group_by(patient) %>% 
    reframe(mean = mean(X7, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("patient")) %>%
  rowwise() %>% 
  mutate(Distance = X7-mean) %>% 
  ungroup() 
   
  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelX7 <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>%  
    select(patient, MeasureWithinTest, timestamp, "M.X7"=X7)
  
  # Remove tests with only 1 measure
  IDs <- SelX7 %>% 
    count(patient) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(patient)) %>% select(ID) %>% t() %>% as.character()

  SelX7 <- SelX7 %>% 
    mutate(ID=paste0(patient)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  
  # For R7R19
  #-----------
  Means <- MeasuresDT %>% 
    group_by(patient) %>% 
    reframe(mean = mean(R7R19, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("patient")) %>%
  rowwise() %>% 
  mutate(Distance = R7R19-mean) %>% 
  ungroup() 
   
  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelR7R19 <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>% 
    select(patient, MeasureWithinTest, timestamp, "M.R7R19"=R7R19)
  
  # Remove tests with only 1 measure
  IDs <- SelR7R19 %>% 
    count(patient) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(patient)) %>% select(ID) %>% t() %>% as.character()

  SelR7R19 <- SelR7R19 %>% 
    mutate(ID=paste0(patient)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  
  # For AX
  #-----------
  Means <- MeasuresDT %>% 
    group_by(patient) %>% 
    reframe(mean = mean(AX, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("patient")) %>%
  rowwise() %>% 
  mutate(Distance = AX-mean) %>% 
  ungroup() 
   
  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelAX <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>% 
    select(patient, MeasureWithinTest, timestamp,"M.AX"=AX)
  
  # Remove tests with only 1 measure
  IDs <- SelAX %>% 
    count(patient) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(patient)) %>% select(ID) %>% t() %>% as.character()

  SelAX <- SelAX %>% 
    mutate(ID=paste0(patient)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  
  # For FRES
  #-----------
  Means <- MeasuresDT %>% 
    group_by(patient) %>% 
    reframe(mean = mean(FRes, na.rm=T)) 
  
  New <- MeasuresDT %>%
  merge(Means, by=c("patient")) %>%
  rowwise() %>% 
  mutate(Distance = FRes-mean) %>% 
  ungroup() 
   
  New$LLimit<-as.numeric(quantile(New$Distance, 0.075, na.rm=T))
  New$HLimit<-as.numeric(quantile(New$Distance, 0.925, na.rm=T))     
  
  SelFRes <- New %>% 
    mutate(
      Drop = case_when(
        Distance < LLimit ~ 1,
        Distance > HLimit ~ 1,
        Distance == 0 ~ 1, # Only 1 measure per test
        TRUE ~ 0)) %>% 
    filter(Drop ==0 )  %>%  
    select(patient, MeasureWithinTest, timestamp, "M.FRes"=FRes)
  
  # Remove tests with only 1 measure
  IDs <- SelFRes %>% 
    count(patient) %>% 
    filter(n==1) %>% 
    mutate(ID=paste0(patient)) %>% select(ID) %>% t() %>% as.character()

  SelFRes <- SelFRes %>% 
    mutate(ID=paste0(patient)) %>% 
    filter(ID %notin% c(IDs)) %>% 
    select(-ID)
  
  
  # MERGE
  #--------
  SelMeasures <- SelR7 %>% 
    merge(SelX7, by=c("patient", "MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(SelR7R19, by=c("patient", "MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(SelAX, by=c("patient", "MeasureWithinTest", "timestamp"), all=T) %>% 
    merge(SelFRes, by=c("patient", "MeasureWithinTest", "timestamp"), all=T) 

  SelMeasures
  
  }
```





## + R7 CoV 15

This function selects the first 3 measurements that have a coefficient of variation of R7 <=15%.

```{r}
ChooseXFromFirstY <- function(data, idsToRemove, choose, fromFirst){
  
  `%notin%` <- Negate(`%in%`)
  
  # Choose measurements that did not had a cv<15 before
  FOT2 <- data %>% 
    # Create a test ID. In this example, each child has only one test
    mutate(.,id = paste0(patient)) %>%
    filter(id %notin% c(idsToRemove)) 

  # Choose combinations of measurements to try
  ChooseXfromFirstY <- data.frame(arrangements::combinations(seq(1,fromFirst, by=1), choose))
  ChooseXfromFirstY_minus1 <- data.frame(arrangements::combinations(seq(1, fromFirst-1, by=1), choose))
  ChooseXfromFirstYUni <- ChooseXfromFirstY %>% setdiff(ChooseXfromFirstY_minus1)
  
  # Calculate test averages from the combinations not tried before
  SEL <- data.frame()
     for (z in 1:nrow(ChooseXfromFirstYUni)) {
     SEL <- SEL %>%  
               bind_rows(bind_cols(CreateTest(c(as.vector(ChooseXfromFirstYUni[z,])), FOT2), ChooseXfromFirstYUni[z,]))
   }
   
  # Select the tests with X measurements, that have a cv <= 15 and has the smallest combined CV
  SEL <- SEL %>% 
    filter(total==choose & r7_cv<=15) %>%
    rowwise() %>%
    mutate(sum = r7_cv) %>%
    ungroup() 
  
  SEL <- SEL %>% 
    group_by(., patient) %>% 
    mutate(Choose = suppressWarnings(ifelse(sum == min(sum),1,0))) %>%
    ungroup() %>%
    filter(Choose==1) 
  
 # Extract the measurements that meet the criteria
  SEL <- SEL %>%
    pivot_longer(cols = X1:paste0("X",choose),
                   names_to = "Selection",
                   names_prefix = "X",
                   values_to = "MeasNumber") %>% 
    mutate(MeasureWithinTest = paste0("Measure ", MeasNumber)) %>% 
    select(patient, MeasureWithinTest) %>% 
    merge(data, all.x = T) 
    
  
# Extract IDs of test with a CV<=15, these already met criteria
  ids <- SEL %>%
    # Create a test ID. In this example, each child has only one test
    mutate(.,id = paste0(patient)) %>%
    select(id) %>%
    distinct() %>% 
    t() %>% as.character()
  
  # output
  list(SEL=SEL, ids=ids)
}
```



```{r}
CreateTest <- function(M, data){
    # Filter to selectt measures 
    data <- data %>%
        mutate(measNum=as.numeric(substring(MeasureWithinTest, 9,9))) %>% 
        filter(measNum %in% c(M)) 
    # Group by to select the level of the test
    data %>%
       group_by(., patient) %>% 
    # Summarize
    summarise(total = n(), 
            r7 = mean(M.R7),
            r7_sd = sd(M.R7),
            r7_cv = r7_sd / r7*100) %>%
     ungroup() 
 }
```


# 3. Function to compute tests from measurements


```{r}

ComputeTests_subset <- function(MeasuresDT){
  
  TestDT <- MeasuresDT %>% 
    mutate(Date = as.Date(timestamp)) %>% 
    group_by(patient, Date) %>% 
    reframe(nMeasuresContributing = n(), 
            T.R7 =mean(M.R7, na.rm=T),
            T.X7 = mean(M.X7, na.rm=T),
            T.R7R19 = mean(M.R7R19, na.rm=T),
            T.AX = mean(M.AX, na.rm=T),
            T.FRes = mean(M.FRes, na.rm=T))
            
  TestDT
  
}
```



```{r}

ComputeTests <- function(MeasuresDT){
  
  TestDT <- MeasuresDT %>% 
    mutate(Date = as.Date(timestamp)) %>% 
    group_by(patient, Date) %>% 
    reframe(nMeasuresContributing = n(), 
            T.R7 =mean(M.R7, na.rm=T),
            T.R11 =mean(M.R11, na.rm=T),
            T.R13 =mean(M.R13, na.rm=T),
            T.R17 =mean(M.R17, na.rm=T),
            T.R19 =mean(M.R19, na.rm=T),
            T.R23 =mean(M.R23, na.rm=T),
            T.R29 =mean(M.R29, na.rm=T),
            T.R31 =mean(M.R31, na.rm=T),
            T.R37 =mean(M.R37, na.rm=T),
            T.R41 =mean(M.R41, na.rm=T),
            T.X7 = mean(M.X7, na.rm=T),
            T.R7R19 = mean(M.R7R19, na.rm=T),
            T.AX = mean(M.AX, na.rm=T),
            T.FRes = mean(M.FRes, na.rm=T))
            
  TestDT
  
}
```


# THE END
